/dts-v1/;
/plugin/;

#define MIPI_DSI_MODE_VIDEO						1
#define MIPI_DSI_MODE_VIDEO_BURST				2
#define MIPI_DSI_MODE_VIDEO_SYNC_PULSE			4
#define MIPI_DSI_MODE_VIDEO_AUTO_VERT			8
#define MIPI_DSI_MODE_VIDEO_HSE					16
#define MIPI_DSI_MODE_VIDEO_NO_HFP				32
#define MIPI_DSI_MODE_VIDEO_NO_HBP				64
#define MIPI_DSI_MODE_VIDEO_NO_HSA				128
#define MIPI_DSI_MODE_VSYNC_FLUSH				256
#define MIPI_DSI_MODE_NO_EOT_PACKET				512
#define MIPI_DSI_CLOCK_NON_CONTINUOUS			1024
#define MIPI_DSI_MODE_LPM						2048

#define DRM_MODE_FLAG_PHSYNC					1
#define DRM_MODE_FLAG_NHSYNC					2
#define DRM_MODE_FLAG_PVSYNC					4
#define DRM_MODE_FLAG_NVSYNC					8
#define DRM_MODE_FLAG_INTERLACE					16
#define DRM_MODE_FLAG_DBLSCAN					32
#define DRM_MODE_FLAG_CSYNC						64
#define DRM_MODE_FLAG_PCSYNC					128
#define DRM_MODE_FLAG_NCSYNC					256
#define DRM_MODE_FLAG_HSKEW						512
#define DRM_MODE_FLAG_BCAST						1024
#define DRM_MODE_FLAG_PIXMUX					2048
#define DRM_MODE_FLAG_DBLCLK					4096
#define DRM_MODE_FLAG_CLKDIV2					8192

#define BCM2835_FSEL_GPIO_IN					0
#define BCM2835_FSEL_GPIO_OUT					1
#define BCM2835_FSEL_ALT5						2
#define BCM2835_FSEL_ALT4						3
#define BCM2835_FSEL_ALT0						4
#define BCM2835_FSEL_ALT1						5
#define BCM2835_FSEL_ALT2						6
#define BCM2835_FSEL_ALT3						7

#define BCM2835_PUD_OFF							0
#define BCM2835_PUD_DOWN						1
#define BCM2835_PUD_UP							2

#define GPIO_ACTIVE_HIGH 						0
#define GPIO_ACTIVE_LOW 						1

#define DRM_MODE_PANEL_ORIENTATION_NORMAL		0
#define DRM_MODE_PANEL_ORIENTATION_BOTTOM_UP	1
#define DRM_MODE_PANEL_ORIENTATION_LEFT_UP		2
#define DRM_MODE_PANEL_ORIENTATION_RIGHT_UP		3

/ {
    compatible = "brcm,bcm2835";

	fragment@0 {
		target = <&gpio>;
		__overlay__ {

			reset_pins: reset_pins {
				brcm,pins = <22>;
				brcm,function = <BCM2835_FSEL_GPIO_OUT>;    /* out */
                brcm,pull = <BCM2835_PUD_OFF>;              /* no pull */
			};

			bias_pins: bias_pins {
				brcm,pins = <24 25>;
				brcm,function = <BCM2835_FSEL_GPIO_OUT>;    /* out */
                brcm,pull = <BCM2835_PUD_OFF>;              /* no pull */
			};

			nunchuk_pins: nunchuk_pins {
				brcm,pins = <46 47>;
				brcm,function = <BCM2835_FSEL_ALT0>;    	/* i2c */
                brcm,pull = <BCM2835_PUD_OFF>;              /* no pull */
			};
		};
	};

    fragment@1 {
        target-path = "/";
        __overlay__ {

            avdd_5v7_reg: fixedregulator_pos_5v7 {
                compatible = "regulator-fixed";
                regulator-name = "lcm_pos_bias";
                regulator-min-microvolt = <5700000>;
                regulator-max-microvolt = <5700000>;
                gpio = <&gpio 24 GPIO_ACTIVE_HIGH>;
                enable-active-high;
            };

            avee_5v7_reg: fixedregulator_neg_5v7 {
                compatible = "regulator-fixed";
                regulator-name = "lcm_neg_bias";
                regulator-min-microvolt = <5700000>;
                regulator-max-microvolt = <5700000>;
                gpio = <&gpio 25 GPIO_ACTIVE_HIGH>;
                enable-active-high;
            };

            vdd_1v8_reg: fixedregulator_1v8 {
                compatible = "regulator-fixed";
                regulator-always-on;
                regulator-max-microvolt = <1800000>;
                regulator-min-microvolt = <1800000>;
                regulator-name = "1v8";
            };
        };
    };

	fragment@2 {
		target = <&dsi1>;
		__overlay__{
			status = "okay";
			#address-cells = <1>;
			#size-cells = <0>;

			port {
				dsi_out_port:endpoint {
					remote-endpoint = <&panel_dsi_port>;
				};
			};

			lpm035m407b:lpm035m407b@0 {
				compatible    = "jdi,lpm035m407b-video";
				status        = "okay";
				reg           = <0>;
				
				reset-gpios   = <&gpio 22 GPIO_ACTIVE_HIGH>;   /* reset */
                vddi-supply   = <&vdd_1v8_reg>;
                avdd-supply   = <&avdd_5v7_reg>;
                avee-supply   = <&avee_5v7_reg>;

				debug-on;	/* Remove this for default config */

				panel-orient  = <DRM_MODE_PANEL_ORIENTATION_LEFT_UP>;
				video-flags   = <(MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_LPM | MIPI_DSI_CLOCK_NON_CONTINUOUS)>;
				panel-mode = 	<142000>,				/* .clock */
								<1440>,					/* .hdisplay */
								<(1440 + 30)>,			/* .hsync_start */
								<(1440 + 30 + 2)>,		/* .hsync_end */
								<(1440 + 30 + 2 + 30)>,	/* .htotal */
								<1600>,					/* .vdisplay */
								<(1600 + 10)>,			/* .vsync_start */
								<(1600 + 10 + 2)>,		/* .vsync_end */
								<(1600 + 10 + 2 + 10)>,	/* .vtotal */
								<60>,					/* .width_mm */
								<66>,					/* .height_mm */
								<0>;						/* .flags */

				on-cmds       =
					[02 FF 10],				/* Page select */
					[02 FB 01],				/* Reload */
					[05 2A 00 00 05 9F],		/* SET_HORIZONTAL_ADDRESS */
					[05 2B 00 00 06 3F],		/* SET_VERTICAL_ADDRESS */
					[02 35 00],				/* SET_TEAR_ON */
					[02 BA 07],				/* SET_MIPI_LANE (4-lane x 1-port) */
					[02 BB 13],				/* SETDSIMODE (03: Video Mode bypass RAM, 10: Command Mode, 13: Video Mode with RAM) */
					[02 E5 00],				/* BK_EN (Random 00h, Black 01h) */

					[02 FF 26],				/* Page select (PWM adjustment for JDI reccomended video timing) */
					[02 FB 01],				/* Reload */
					[02 02 C0],				/* DELY_VID */
					[02 03 00],				/* DELY_VID */

					[02 FF 25],				/* Page select */
					[02 FB 01],				/* Reload */
					[02 62 60],				/* PIN_CTRL3 */
					[02 65 00],				/* VSOUTS_1 */
					[02 66 07],				/* VSOUTS_2 */
					[02 67 56],				/* VSOUTW */

					[02 FF D0],				/* Page select */
					[02 FB 01],				/* Reload */
					[02 05 88],				/* Adjustment of timing */

					[02 FF 10],				/* Page select */
					[02 FB 01],				/* Reload */
					[02 C0 00],				/* Compression (80: No compression, 83: VESA_DSC) */
					//[05 BE 01 90 0F 39],	/* RGBMIPICTRL_HF */
					[04 3B 03 0A 0A],
					//[06 3B 03 0A 0A 04 04],
					//[05 3B 00 0A 00 0A],
				
					/* Leave here */
					[02 FF 10],
					[02 FB 01];

				port {
					panel_dsi_port: endpoint {
						remote-endpoint = <&dsi_out_port>;
					};
				};
			};
		};
	};

	fragment@3 {
		target = <&i2c0>;
		__overlay__{
			#address-cells = <1>;
			#size-cells = <0>;
			status = "okay";
			pinctrl-names = "default";
			pinctrl-0 = <&nunchuk_pins>;

			nunchuk: nunchuk@52 {
				compatible = "nintendo,nunchuk-joystick";
				reg = <0x52>;
			};
		};
	};
};